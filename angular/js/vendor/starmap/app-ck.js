/*
INSPIRATIONS:
Structure inspired by:
	http://viget.com/extend/2666
Page Visibility API and Polyfill for vendor prefixes:
	http://stackoverflow.com/questions/1060008/is-there-a-way-to-detect-if-a-browser-window-is-not-currently-active
	http://www.w3.org/TR/page-visibility/
	http://caniuse.com/#feat=pagevisibility
	http://jsfiddle.net/0GiS0/cAG5N/
*/var Starmap=Starmap||function(){var APP={stage:null,container:null,initiated:!1,states:{INIT:"INIT",READY:"READY"},currentState:"INIT",props:{now:null,then:null,interval:0,width:600,height:300,textColor:"#FFFD8A",keycodes:{SPACE:32,LEFT:37,RIGHT:39,UP:38,DOWN:40},assets:[{id:"canvas_book",src:"img/html5-canvas-book.jpg"},{id:"lynda",src:"img/lynda-logo-square-200.gif"},{id:"curiosity",src:"img/curiosity-tars-tarkas.jpg"},{id:"ie6_old",src:"img/ie6-old.png"}],regionProps:{UFP:{color:"rgba(110, 200, 250, 1)",fullName:"United Federation of Planets"},KE:{color:"rgba(255, 0, 0, 1)",fullName:"Klingon Empire"},RSA:{color:"rgba(190, 20, 190, 1)",fullName:"Romulan Star Empire"},AOFW:{color:"rgba(200, 200, 0, 1)",fullName:"Affiliation of Outer Free Worlds"},OFMA:{color:"rgba(0, 255, 0, 1)",fullName:"Orion Free Merchantile Association"},MCA:{color:"rgba(150, 150, 255, 1)",fullName:"Mantiev Colonial Association"},IKS:{color:"rgba(255, 150, 150, 1)",fullName:"Independent Klingon States"},I:{color:"rgba(0, 255, 0, 1)",fullName:"Independent"},U:{color:"rgba(150, 150, 150, 1)",fullName:"Unexplored"}},startingPoint:{x:-440,y:-780},mousedown:!1,dragging:!1,timeStamp:0,scaleXY:2,fpsText:"",systems:[],stars:[],regions:[]},pause:function(){createjs.Ticker.paused=!0},play:function(){APP.props.then=Date.now();createjs.Ticker.paused=!1},init:function(targetID,systemsArray){function handleFileLoad(event){}function handleComplete(event){APP.setup.createObjects();APP.play();APP.stage.removeChild(APP.loadGraphic);APP.currentState=APP.states.READY}APP.initiated=!0;APP.ngCtrl=angular.element(document.getElementById("atlas")).controller();typeof document.hidden!="undefined"?(APP.hidden="hidden",APP.visibilityChange="visibilitychange",APP.visibilityState="visibilityState"):typeof document.mozHidden!="undefined"?(APP.hidden="mozHidden",APP.visibilityChange="mozvisibilitychange",APP.visibilityState="mozVisibilityState"):typeof document.msHidden!="undefined"?(APP.hidden="msHidden",APP.visibilityChange="msvisibilitychange",APP.visibilityState="msVisibilityState"):typeof document.webkitHidden!="undefined"&&(APP.hidden="webkitHidden",APP.visibilityChange="webkitvisibilitychange",APP.visibilityState="webkitVisibilityState");APP.document_hidden=document[APP.hidden];APP.props.systems=systemsArray;APP.setup.createCanvas(targetID);APP.setup.addListeners();APP.setup.createloadGraphic();var queue=new createjs.LoadQueue(!0);queue.loadManifest(APP.props.assets);queue.on("fileload",handleFileLoad,this);queue.on("complete",handleComplete,this)},setup:{createCanvas:function(targetID){APP.canvas=document.createElement("canvas");APP.canvas.width=APP.props.width;APP.canvas.height=APP.props.height;APP.context=APP.canvas.getContext("2d");document.getElementById(targetID).appendChild(APP.canvas);APP.setup.matchSizeToParent();APP.stage=new createjs.Stage(APP.canvas);createjs.Touch.enable(APP.stage,!0,!1)},matchSizeToParent:function(){APP.canvas.width=APP.canvas.parentElement.clientWidth;APP.canvas.height=APP.canvas.parentElement.clientHeight;var parent=APP.canvas.parentElement;return{width:APP.canvas.parentElement.clientWidth,height:APP.canvas.parentElement.clientHeight}},addListeners:function(){document.addEventListener(APP.visibilityChange,function(){if(APP.document_hidden!==document[APP.hidden]){document[APP.hidden]?APP.pause():APP.play();APP.document_hidden=document[APP.hidden]}});document.onkeydown=function(event){event=event||window.event;switch(event.which||event.keyCode){case APP.props.keycodes.SPACE:var paused=!createjs.Ticker.getPaused();createjs.Ticker.setPaused(paused);break;case APP.props.keycodes.LEFT:console.log("LEFT");break;case APP.props.keycodes.UP:console.log("UP");break;case APP.props.keycodes.RIGHT:console.log("RIGHT");break;case APP.props.keycodes.DOWN:console.log("DOWN");break;default:return}event.preventDefault()};var throttled=_.throttle(APP.setup.matchSizeToParent,250);$(window).resize(throttled);APP.stage.on("stagemousedown",function(event){APP.props.mousedown=!0;APP.props.timeStamp=event.timeStamp;APP.container.offset={x:APP.container.x-event.stageX,y:APP.container.y-event.stageY};console.log(APP.utils.stageToMap({x:event.stageX,y:event.stageY}))});APP.stage.on("stagemousemove",function(event){APP.props.mousedown===!0&&event.timeStamp-APP.props.timeStamp>150&&(APP.props.dragging=!0);if(APP.props.dragging===!0){APP.container.x=event.stageX+APP.container.offset.x;APP.container.y=event.stageY+APP.container.offset.y}});APP.stage.on("stagemouseup",function(event){APP.props.mousedown=!1;APP.props.dragging!==!1&&(APP.props.dragging=!1)});createjs.Ticker.on("tick",APP.tick);APP.props.now=Date.now();APP.props.then=createjs.Ticker.now;createjs.Ticker.timingMode=createjs.Ticker.RAF},createloadGraphic:function(){APP.loadGraphic=new createjs.Shape;APP.loadGraphic.graphics.beginFill("#4385E0").drawCircle(0,0,50);APP.loadGraphic.x=100;APP.loadGraphic.y=100;APP.stage.addChild(APP.loadGraphic)},createObjects:function(){var topLimit=0,rightLimit=0;bottomLimit=0;leftLimit=0;APP.container=new createjs.Container;APP.container.scaleX=APP.container.scaleY=APP.props.scaleXY;APP.container.x=APP.props.startingPoint.x*APP.props.scaleXY;APP.container.y=APP.props.startingPoint.y*APP.props.scaleXY;APP.stage.addChild(APP.container);var numStars=10;for(i=0;i<APP.props.systems.length;i++){var tempStar=new classes.Star({canvas:APP.canvas,id:APP.props.systems[i].id,name:APP.props.systems[i].name,x:Math.ceil(APP.props.systems[i].x*100),y:Math.ceil(APP.props.systems[i].y*-100),radius:2,color:APP.props.regionProps[APP.props.systems[i].affiliation].color});APP.props.stars.push(tempStar);APP.container.addChild(tempStar)}var firstX=_.min(APP.props.stars,function(star){return star.x}).x,firstY=_.min(APP.props.stars,function(star){return star.y}).y,lastX=_.max(APP.props.stars,function(star){return star.x}).x,lastY=_.max(APP.props.stars,function(star){return star.y}).y;console.log("firstX: "+firstX+", firstY: "+firstY+", lastX: "+lastX+", lastY: "+lastY);APP.container.setBounds(firstX,firstY,lastX-firstX,lastY-firstY);console.log(APP.container.getBounds())}},tick:function(event){if(createjs.Ticker.paused===!1){APP.updateInterval();switch(APP.currentState){case"INIT":APP.updateloadGraphic(APP.props.interval);break;default:APP.updateObjects(APP.props.interval)}APP.stage.update(event)}},getFPS:function(elapsed){var now=createjs.Ticker.getTime(),fps=0,tempFPS=Math.round(1e3/(elapsed*1e3));fps=isFinite(tempFPS)?tempFPS:0;return fps},angularAPI:{getLocation:function(){return APP.ngCtrl.getLocation()},getCurrent:function(){return APP.ngCtrl.getCurrent()},getOrigin:function(){return APP.ngCtrl.getOrigin()},getDestination:function(){return APP.ngCtrl.getDestination()},setCurrent:function(){},setOrigin:function(x,y){APP.ngCtrl.setOrigin(x,y)},setDestination:function(x,y){APP.ngCtrl.setDestination(x,y)},logSomething:function(message){APP.ngCtrl.log(message)}},utils:{getNearestFromPoint:function(testPointX,testPointY){testPointX=(testPointX/100).toFixed(2);testPointY=(testPointY/-100).toFixed(2);var nearestArray=STRPG.utils.sortByDistance(testPointX,testPointY,STRPG.data.systems);nearestArray[0].distanceFrom=(nearestArray[0].distanceFrom*100).toFixed(0);return nearestArray[0]},stageToMap:function(stagePoint){return{x:Math.round((stagePoint.x-APP.container.x)/APP.props.scaleXY),y:Math.round((stagePoint.y-APP.container.y)/APP.props.scaleXY)}},mapToStage:function(mapPoint){return{x:Math.round(mapPoint.x*APP.props.scaleXY+APP.container.x),y:Math.round(mapPoint.y*APP.props.scaleXY+APP.container.y)}}},correctPosition:function(){var bounds=APP.container.getBounds(),marginX=20,marginY=80,dragLimit={UL:{x:-(bounds.x*APP.props.scaleXY),y:-(bounds.y*APP.props.scaleXY)},BR:{x:-((bounds.x+bounds.width)*APP.props.scaleXY-APP.canvas.width),y:-((bounds.y+bounds.height)*APP.props.scaleXY-APP.canvas.height)-marginY}};if(bounds.width*APP.props.scaleXY>APP.canvas.width){APP.container.x=APP.container.x>dragLimit.UL.x+marginX?dragLimit.UL.x+marginX:APP.container.x;APP.container.x=APP.container.x<dragLimit.BR.x+marginX?dragLimit.BR.x-marginX:APP.container.x}else{var diff=APP.canvas.width-bounds.width*APP.props.scaleXY;APP.container.x=dragLimit.UL.x+marginX+diff/2}if(bounds.height*APP.props.scaleXY>APP.canvas.height){APP.container.y=APP.container.y>dragLimit.UL.y+marginY?dragLimit.UL.y+marginY:APP.container.y;APP.container.y=APP.container.y<dragLimit.BR.y?dragLimit.BR.y:APP.container.y}else{var diff=APP.canvas.height-bounds.height*APP.props.scaleXY;APP.container.y=dragLimit.UL.y+diff/2}},changeScale:function(modifier){var canvasCenter={x:APP.canvas.width/2,y:APP.canvas.height/2},pointBefore=APP.utils.stageToMap(canvasCenter);APP.props.scaleXY+=modifier;var pointAfter=APP.utils.mapToStage(pointBefore);APP.container.x-=pointAfter.x-canvasCenter.x;APP.container.y-=pointAfter.y-canvasCenter.y},updateInterval:function(){APP.props.now=Date.now();APP.props.interval=(APP.props.now-APP.props.then)/1e3;APP.props.then=APP.props.now},updateloadGraphic:function(elapsed){APP.loadGraphic.x+=elapsed/1e3*100;APP.loadGraphic.x>APP.canvas.width&&(APP.loadGraphic.x-=APP.canvas.width)},updateObjects:function(elapsed){var starsArray=APP.props.stars;APP.container.scaleX=APP.container.scaleY=APP.props.scaleXY;APP.correctPosition()}};return APP}();